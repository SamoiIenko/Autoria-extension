chrome.extension.onMessage.addListener(
    function(message, sender){
        switch (message.context) {
        
        }
    }
);

const fuel = `
<svg id="Capa_1" class="fuel-icon" enable-background="new 0 0 511.965 511.965" height="512" viewBox="0 0 511.965 511.965" width="512" xmlns="http://www.w3.org/2000/svg">
    <path d="m392.437.154h-146.458c-16.424 0-31.901 6.124-43.58 17.245l-34.55 32.894-25.272-25.31c5.273-5.893 5.094-14.939-.569-20.596-5.862-5.856-15.36-5.849-21.213.012l-86.85 86.947c-5.855 5.861-5.85 15.358.012 21.213 2.929 2.926 6.765 4.388 10.601 4.388 3.57 0 7.131-1.284 9.968-3.816l11.688 11.704 11.382 11.386-26.097 24.846c-11.709 11.147-18.425 26.642-18.425 42.51v222.011c0 47.628 40.36 86.377 89.97 86.377h269.395c49.609 0 89.97-38.748 89.97-86.376v-339.058c-.002-47.628-40.362-86.377-89.972-86.377zm-316.68 91.783 45.652-45.703c8.681 8.688 17.867 17.884 24.714 24.744l-46.798 44.554c-6.518-6.522-15.264-15.279-23.568-23.595zm376.65 333.652c0 31.086-26.902 56.376-59.97 56.376h-269.394c-33.067 0-59.97-25.291-59.97-56.377v-222.011c0-7.808 3.235-15.188 9.11-20.782l150.903-143.669c5.988-5.701 14.332-8.972 22.894-8.972h146.458c33.067 0 59.97 25.291 59.97 56.377v339.058z"/>
    <path d="m375.568 77.346h-155.547c-3.845 0-7.543 1.477-10.33 4.124l-70 66.489c-4.45 4.227-5.876 10.737-3.601 16.438 2.275 5.7 7.794 9.438 13.931 9.438h225.547c26.581 0 48.206-21.642 48.206-48.244 0-26.603-21.625-48.245-48.206-48.245zm0 66.489h-187.974l38.416-36.489h149.559c10.039 0 18.206 8.185 18.206 18.245-.001 10.059-8.168 18.244-18.207 18.244z"/>
    <path d="m383.76 208.34c-5.857-5.857-15.355-5.857-21.213 0l-92.349 92.349-92.348-92.349c-5.857-5.859-15.355-5.857-21.213 0s-5.858 15.355 0 21.213l92.349 92.349-92.349 92.349c-5.858 5.857-5.858 15.355 0 21.213 2.929 2.929 6.768 4.394 10.606 4.394 3.839 0 7.678-1.465 10.607-4.394l92.349-92.349 92.349 92.349c2.929 2.93 6.768 4.394 10.606 4.394s7.678-1.465 10.606-4.394c5.858-5.857 5.858-15.355 0-21.213l-92.349-92.349 92.349-92.349c5.858-5.858 5.858-15.356 0-21.213z"/>
</svg>
`;

const gearbox = `
<svg id="Layer_1" class="gearbox-icon" enable-background="new 0 0 512 512" height="512" viewBox="0 0 512 512" width="512" xmlns="http://www.w3.org/2000/svg">
    <path d="m350.21 219h-56.71v-71.629c14.208-7.751 26.017-19.811 33.256-34.834 1.798-3.731.23-8.214-3.501-10.012-3.729-1.797-8.213-.231-10.013 
    3.5-10.53 21.854-32.999 35.975-57.242 35.975-35.014 0-63.5-28.486-63.5-63.5 0-4.911.579-9.687 1.639-14.281.455 1.586.987 3.162 1.619 4.719 11.02 
    27.105 34.665 44.62 60.241 44.62 26.022 0 49.843-17.95 60.685-45.731.452-1.158.848-2.328 1.2-3.505 1.045 4.563 1.616 9.304 1.616 14.179 0 4.142 
    3.357 7.5 7.5 7.5s7.5-3.358 7.5-7.5c0-26.13-12.845-49.304-32.54-63.581-14.619-10.338-30.062-14.92-45.96-14.92-15.423 0-31.462 4.582-45.025 14.254-20.222 
    14.214-33.475 37.705-33.475 64.246 0 29.712 16.594 55.619 41 68.947v20.425c0 4.142 3.357 7.5 7.5 7.5s7.5-3.358 7.5-7.5v-14.173c7.132 2.138 14.681 3.302 
    22.5 3.302 7.718 0 15.288-1.166 22.5-3.346v121.525c0 6.005-2.342 11.655-6.594 15.907-4.251 4.251-9.9 6.593-15.906 6.593-12.406 
    0-22.5-10.093-22.5-22.5v-75.309c0-4.142-3.357-7.5-7.5-7.5s-7.5 3.358-7.5 7.5v19.129h-56.71c-43.721 0-79.29 35.569-79.29 79.29v134.42c0 43.721 35.569 79.29 
    79.29 79.29h188.42c43.721 0 79.29-35.569 79.29-79.29v-134.42c0-43.721-35.569-79.29-79.29-79.29zm-57.286-192.112c10.617 8.175 14.743 22.782 9.787 35.485-8.579 
    21.981-26.914 36.184-46.711 36.184-19.743 0-37.502-13.514-46.345-35.268-5.436-13.371-1.078-28.651 10.335-37.052 10.241-7.078 22.646-11.237 36.01-11.237 13.765 
    0 26.511 4.417 36.924 11.888zm43.516 225.352c9.958 0 18.06 8.106 18.06 18.07v115.71c0 9.964-8.102 18.07-18.06 18.07h-160.88c-9.958 
    0-18.06-8.106-18.06-18.07v-115.71c0-9.964 8.102-18.07 18.06-18.07h6.301v80.34c0 16.189 13.171 29.36 29.359 29.36h89.561c16.188 0 29.359-13.171 
    29.359-29.36v-80.34zm-117.94-18.24v41.18c0 20.678 16.822 37.5 37.5 37.5 10.013 0 19.429-3.902 26.514-10.987s10.986-16.501 10.986-26.513v-41.18h7.28c7.918 
    0 14.359 6.442 14.359 14.36v84.22c0 7.918-6.441 14.36-14.359 14.36h-89.56c-7.918 0-14.359-6.442-14.359-14.36v-84.22c0-7.918 6.441-14.36 14.359-14.36zm196 
    198.71c0 35.45-28.841 64.29-64.29 64.29h-188.42c-35.449 0-64.29-28.84-64.29-64.29v-134.42c0-35.45 28.841-64.29 64.29-64.29h23.836c-.587 1.043-1.114 
    2.124-1.572 3.24h-8.494c-10.901 0-20.583 5.307-26.608 13.472-21.301 5.742-36.451 25.252-36.451 47.578v134.42c0 27.179 22.111 49.29 49.29 49.29h127.209c4.143
    0 7.5-3.358 7.5-7.5s-3.357-7.5-7.5-7.5h-127.21c-18.907 0-34.29-15.382-34.29-34.29v-134.42c0-11.594 5.872-22.096 15.009-28.339-.001.12-.009.239-.009.359v115.71c0 
    18.235 14.83 33.07 33.06 33.07h160.88c18.229 0 33.06-14.835 33.06-33.07v-115.71c0-.12-.008-.239-.009-.359 9.137 6.244 15.009 16.746 15.009 28.339v134.42c0 
    18.908-15.383 34.29-34.29 34.29h-29.694c-4.143 0-7.5 3.358-7.5 7.5s3.357 7.5 7.5 7.5h29.694c27.179 0 49.29-22.111 
    49.29-49.29v-134.42c0-22.326-15.15-41.837-36.451-47.578-6.026-8.164-15.707-13.472-26.608-13.472h-8.494c-.458-1.116-.985-2.197-1.572-3.24h23.836c35.449 
    0 64.29 28.84 64.29 64.29v134.42z"/>
    <path d="m231 70.298c4.143 0 7.5-3.358 7.5-7.5v-3.399h10v3.399c0 4.142 3.357 7.5 7.5 7.5s7.5-3.358 7.5-7.5v-3.399h10v3.399c0 4.142 3.357 7.5 7.5 7.5s7.5-3.358 
    7.5-7.5v-21.798c0-4.142-3.357-7.5-7.5-7.5s-7.5 3.358-7.5 7.5v3.398h-10v-3.398c0-4.142-3.357-7.5-7.5-7.5s-7.5 3.358-7.5 
    7.5v3.398h-10v-3.398c0-4.142-3.357-7.5-7.5-7.5s-7.5 3.358-7.5 7.5v21.798c0 4.142 3.357 7.5 7.5 7.5z"/>
</svg>
`;

const city = `
<svg version="1.1" id="Layer_1" class="city-icon" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve">
		<path d="M256,0C161.896,0,85.333,76.563,85.333,170.667c0,28.25,7.063,56.26,20.49,81.104L246.667,506.5
			c1.875,3.396,5.448,5.5,9.333,5.5s7.458-2.104,9.333-5.5l140.896-254.813c13.375-24.76,20.438-52.771,20.438-81.021
			C426.667,76.563,350.104,0,256,0z M256,256c-47.052,0-85.333-38.281-85.333-85.333c0-47.052,38.281-85.333,85.333-85.333
			s85.333,38.281,85.333,85.333C341.333,217.719,303.052,256,256,256z"/>
</svg>
`;

const mileage = `
<svg version="1.1" id="Capa_1" class="mileage-icon" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="501.015px" height="501.015px" viewBox="0 0 501.015 501.015" style="enable-background:new 0 0 501.015 501.015;"
	 xml:space="preserve">
	<path d="M242.105,115.922L242.105,115.922h-0.006V96.015V56.188h0.006h16.804v59.734h-0.018v0.012l-8.391-0.012H242.105z
		 M39.555,317.098l41.919-7.389l16.908-2.979v-0.012h0.006l-1.478-8.334l-1.442-8.193h-0.006v-0.012l-58.83,10.368L39.555,317.098z
		 M411.266,169.234l-30.228,17.437v0.012l0,0l4.663,8.086l3.735,6.452l0,0l51.731-29.864l-8.405-14.549L411.266,169.234z
		 M150.24,390.923l-6.623-5.556l0,0l0,0l-38.402,45.749l12.879,10.805l16.71-19.919l21.687-25.842l0,0L150.24,390.923z
		 M432.562,386.81l8.394-14.559l-18.046-10.421l-33.673-19.458v0.012l0,0l-4.641,8.027l-3.753,6.514l0,0v0.012L432.562,386.81z
		 M36.703,242.282l20.98,3.686l37.84,6.69v-0.012h0.006l2.5-14.215l0.405-2.329v-0.012l-58.827-10.382L36.703,242.282z
		 M461.04,226.158l-15.989,2.813l-42.841,7.542v0.012h-0.006l2.163,12.256l0.757,4.279l0,0v0.012l58.836-10.367L461.04,226.158z
		 M189.346,128.104v0.012l13.636-4.974l2.143-0.78h0.006l-20.422-56.14l-15.791,5.757l2.911,8.003L189.346,128.104L189.346,128.104z
		 M67.814,386.431l51.725-29.86v-0.012l0,0l-6.469-11.201l-1.93-3.346l0,0l0,0l-51.734,29.861l8.402,14.552h0.006V386.431z
		 M343.782,396.432l38.396,45.773L395.04,431.4v-0.012l-38.385-45.762v0.012v-0.012l-8.931,7.495L343.782,396.432L343.782,396.432z
		 M59.625,170.992L59.625,170.992l51.731,29.876l0,0l7.276-12.613l1.12-1.936v-0.012l-51.731-29.864L59.625,170.992z
		 M463.877,300.973L463.877,300.973l-58.824-10.379l-0.626,3.547l-2.294,13.004l58.83,10.379L463.877,300.973z M118.408,101.05
		l-12.868,10.802l14.109,16.81l24.291,28.948l0,0l0,0l7.601-6.384l5.26-4.412l0,0l0.006-0.012L118.408,101.05z M311.249,80.203
		L295.846,122.5l0.012,0.012l0,0l10.521,3.818l5.261,1.912l0,0h0.006l20.434-56.126l-15.794-5.742L311.249,80.203z M353.712,155.154
		l3.263,2.731l0,0l0,0l38.402-45.767l-12.873-10.79h-0.006l0,0l-38.396,45.752l0,0v0.012L353.712,155.154z M250.507,27.021
		C112.382,27.021,0,139.394,0,277.531c0,79.57,37.333,150.535,95.361,196.462h25.36C57.036,431.778,14.939,359.49,14.939,277.531
		c0-129.896,105.673-235.568,235.567-235.568c129.898,0,235.571,105.672,235.571,235.568c0,81.959-42.097,154.247-105.785,196.462
		h25.363c58.02-45.927,95.358-116.892,95.358-196.462C501.015,139.399,388.633,27.021,250.507,27.021z M201.607,387.234
		c5.255,0,7.876-5.236,7.876-15.698c0-10.829-2.568-16.255-7.713-16.255c-5.423,0-8.139,5.503-8.139,16.521
		C193.631,382.093,196.294,387.234,201.607,387.234z M179.152,336.71h44.553v69.699h-44.553V336.71z M189.177,372.009
		c0,6.124,1.052,10.793,3.165,14.032c2.11,3.233,5.048,4.858,8.819,4.858c4.031,0,7.164-1.702,9.41-5.083
		c2.246-3.398,3.372-8.299,3.372-14.735c0-12.986-3.978-19.482-11.931-19.482c-4.158,0-7.33,1.708-9.531,5.172
		C190.276,360.211,189.177,365.294,189.177,372.009z M229.56,336.71h43.754v69.699H229.56V336.71z M241.053,389.327
		c1.738,1.04,4.359,1.572,7.874,1.572c4.17,0,7.459-1.123,9.847-3.369s3.594-5.213,3.594-8.89c0-3.547-1.111-6.348-3.334-8.394
		c-2.233-2.033-5.378-3.062-9.445-3.062c-0.993,0-2.065,0.035-3.233,0.106v-11.136h14.287v-3.925h-18.403V371.3
		c2.92-0.213,4.909-0.319,5.964-0.319c3.136,0,5.538,0.697,7.214,2.092c1.679,1.396,2.524,3.346,2.524,5.828
		c0,2.519-0.822,4.527-2.471,6.053c-1.646,1.525-3.807,2.281-6.493,2.281c-2.689,0-5.326-0.839-7.93-2.518v4.61H241.053z
		 M277.848,336.71h44.006v69.699h-44.006V336.71z M288.788,372.009c0,6.124,1.053,10.793,3.168,14.032
		c2.11,3.233,5.049,4.858,8.819,4.858c4.031,0,7.17-1.702,9.41-5.083c2.246-3.398,3.369-8.299,3.369-14.735
		c0-12.986-3.984-19.482-11.935-19.482c-4.154,0-7.329,1.708-9.533,5.172C289.888,360.211,288.788,365.294,288.788,372.009z
		 M301.225,387.234c5.249,0,7.879-5.236,7.879-15.698c0-10.829-2.571-16.255-7.714-16.255c-5.426,0-8.139,5.503-8.139,16.521
		C293.245,382.093,295.905,387.234,301.225,387.234z M257.815,300.725c-1.052,0-1.974,0.379-2.943,0.58L140.064,200.018
		L242.191,314.97c-0.068,0.579-0.358,1.1-0.358,1.673c0,8.849,7.144,16,15.982,16c8.784,0,15.924-7.151,15.924-16
		C273.751,307.877,266.6,300.725,257.815,300.725z"/>
</svg> 
`;

const trash = `
<svg id="Layer_1" class="trash" enable-background="new 0 0 512 512" height="512" viewBox="0 0 512 512" width="512" xmlns="http://www.w3.org/2000/svg">
    <path d="m424 64h-88v-16c0-26.467-21.533-48-48-48h-64c-26.467 0-48 21.533-48 48v16h-88c-22.056 0-40 17.944-40 40v56c0 8.836 7.164 16 16 
    16h8.744l13.823 290.283c1.221 25.636 22.281 45.717 47.945 45.717h242.976c25.665 0 46.725-20.081 47.945-45.717l13.823-290.283h8.744c8.836 0 
    16-7.164 16-16v-56c0-22.056-17.944-40-40-40zm-216-16c0-8.822 7.178-16 16-16h64c8.822 0 16 7.178 16 16v16h-96zm-128 56c0-4.411 3.589-8 8-8h336c4.411 0 
    8 3.589 8 8v40c-4.931 0-331.567 0-352 0zm313.469 360.761c-.407 8.545-7.427 15.239-15.981 15.239h-242.976c-8.555 0-15.575-6.694-15.981-15.239l-13.751-288.761h302.44z"/>
    <path d="m256 448c8.836 0 16-7.164 16-16v-208c0-8.836-7.164-16-16-16s-16 7.164-16 16v208c0 8.836 7.163 16 16 16z"/>
    <path d="m336 448c8.836 0 16-7.164 16-16v-208c0-8.836-7.164-16-16-16s-16 7.164-16 16v208c0 8.836 7.163 16 16 16z"/>
    <path d="m176 448c8.836 0 16-7.164 16-16v-208c0-8.836-7.164-16-16-16s-16 7.164-16 16v208c0 8.836 7.163 16 16 16z"/>
</svg>
`;

init();

async function init(){

    const resultPopup = await requestBackground(new ExtensionMessage(config.keys.getCarInfo));
    const carsList = document.querySelector('.cars-list');
    const searchInput = document.querySelector('.search-input');
    const user = await storageGet(OAUTH.user.info);

    if(user) {

        const info = parseJwt(user.id_token);
        const result = await requestBackground(new ExtensionMessage(config.keys.login, {name: `User-${info.email}`, email: info.email}));

        if(result.success) {
            await storageSet({key: config.keys.userId, value: result.userId});
            document.querySelector('.content').style.display = 'block';
            document.querySelector('.login').style.display = 'none';
        } else {
            document.querySelector('.content').style.display = 'none';
            document.querySelector('.login').style.display = 'flex';
            simpleNotify.notify({text: 'Login error.', level: 'red'});
        }

    } else {
        document.querySelector('.login').style.display = 'flex';
    }

    const loginBtn = document.querySelector('.sign-in-google');
    loginBtn.onclick = async () => {
        await requestBackground(new ExtensionMessage(OAUTH.key.auth));
    }

    const logout = document.querySelector('.logout');
    logout.onclick = async () => {
        await storageSet({key: OAUTH.user.info, value: null});
        document.querySelector('.content').style.display = 'none';
        document.querySelector('.login').style.display = 'flex';
    }

    searchInput.onkeyup = async () => {
        let searchWord = searchInput.value;
        const result = await requestBackground(new ExtensionMessage(config.keys.searchCar, {value: searchWord}));

        if(!result.success) {
            simpleNotify.notify({text: result.message, level: 'red'});
            return;
        }
        renderCars(result.searchData, carsList);
    }
    
    renderCars(resultPopup.data, carsList);
}

async function renderCars(data, carsList) {

    carsList.innerHTML = '';
    for(const cars of data) {
        const date = new Date(cars.date).toLocaleDateString();
        const star = `
        <svg height="511pt" class="star ${cars.favorites ? 'active' : ''}" viewBox="0 -10 511.98685 511" width="511pt" xmlns="http://www.w3.org/2000/svg">
            <path d="m114.59375 491.140625c-5.609375 0-11.179688-1.75-15.933594-5.1875-8.855468-6.417969-12.992187-17.449219-10.582031-28.09375l32.9375-145.089844-111.703125-97.960937c-8.210938-7.167969-11.347656-18.519532-7.976562-28.90625 
            3.371093-10.367188 12.542968-17.707032 23.402343-18.710938l147.796875-13.417968 58.433594-136.746094c4.308594-10.046875 14.121094-16.535156 
            25.023438-16.535156 10.902343 0 20.714843 6.488281 25.023437 16.511718l58.433594 136.769532 147.773437 13.417968c10.882813.980469 20.054688 8.34375 
            23.425782 18.710938 3.371093 10.367187.253906 21.738281-7.957032 28.90625l-111.703125 97.941406 32.9375 145.085938c2.414063 10.667968-1.726562 
            21.699218-10.578125 28.097656-8.832031 6.398437-20.609375 6.890625-29.910156 1.300781l-127.445312-76.160156-127.445313 76.203125c-4.308594 
            2.558594-9.109375 3.863281-13.953125 3.863281zm141.398438-112.875c4.84375 0 9.640624 1.300781 13.953124 3.859375l120.277344 
            71.9375-31.085937-136.941406c-2.21875-9.746094 1.089843-19.921875 8.621093-26.515625l105.472657-92.5-139.542969-12.671875c-10.046875-.917969-18.6875-7.234375-22.613281-16.492188l-55.082031-129.046875-55.148438 
            129.066407c-3.882812 9.195312-12.523438 15.511718-22.546875 16.429687l-139.5625 12.671875 105.46875 92.5c7.554687 6.613281 10.859375 16.769531 8.621094 
            26.539062l-31.0625 136.9375 120.277343-71.914062c4.308594-2.558594 9.109376-3.859375 13.953126-3.859375zm-84.585938-221.847656s0 .023437-.023438.042969zm169.128906-.0625.023438.042969c0-.023438 
            0-.023438-.023438-.042969zm0 0"/>
        </svg> 
        `;
        const car = document.createElement('div');

        car.className = 'car';
        car.innerHTML +=`
            <div class="properties">
                <div class="image-area">
                    <img class="image" src=${cars.image} />
                </div>
                <div class="more-area">
                    <p class="title">${cars.title}</p>
                    <p class="price">${cars.price}$</p>
                    <p class="mileage">${mileage} ${cars.mileages} тыс.км</p>
                    <p class="location">${city} ${cars.locations}</p>
                    <p class="fuel">${fuel} ${cars.fuel}<span class="volume">, ${cars.volume} л</span></p>
                    <p class="gearbox">${gearbox} ${cars.gearbox}</p>
                </div>
            </div>
            <div class="footer-area">
                <div class="description-area">
                    <p>${cars.description}</p>
                </div>
                <div class="action-area">
                    <a class="adv" href="${cars.links}">Перейти к объявлению</a>
                    <p class="date">${date}</p>
                    <div class="icon-field">
                        <p>${star}</p>
                        <p class="remove">${trash}</p>
                    </div>
                </div>
            </div>
        `;

        const adv = car.querySelector('a.adv');

        adv.onclick = (e) => {
            e.preventDefault();
            chrome.tabs.create({url: adv.href});
        }
        const remove = car.querySelector('.remove');
        const title = car.querySelector('.title');
        const favorite = car.querySelector('.star');
        remove.onclick = async () => {

            const result = await requestBackground(new ExtensionMessage(config.keys.removeCar, {id: cars.id}));  
            if(!result.success) {
                simpleNotify.notify({text: result.message, level: 'red'});
                return;
            }
            car.remove();
        }
        favorite.onclick = async () => {

            const result = await requestBackground(new ExtensionMessage(config.keys.editCar, {...cars, favorites: favorite.classList.contains('active') ? 0 : 1}));  
            if(!result.success) {
                simpleNotify.notify({text: result.message, level: 'red'});
                return;
            }
            favorite.classList.contains('active') ? favorite.classList.remove('active') : favorite.classList.add('active');
        }
        title.onclick = () => {

            const popup = document.querySelector('.popup');
            const close = document.querySelector('.close');
            const save = document.querySelector('.save');

            popup.style.display = 'block';
            popup.querySelector('.title-input').value = cars.title;
            popup.querySelector('.price-input').value = cars.price;
            close.onclick = () => {
                popup.style.display = 'none';
            }
            save.onclick = async () => {
                const title = popup.querySelector('.title-input').value;
                const price = popup.querySelector('.price-input').value;
                const result = await requestBackground(new ExtensionMessage(config.keys.editCar, {...cars, title: title, price: price}));

                if(!result.success) {
                    simpleNotify.notify({text: result.message, level: 'red'});
                    return;
                }
                car.querySelector('.title').innerText = title;
                car.querySelector('.price').innerText = price;
                popup.style.display = 'none';
            }
        }

        carsList.appendChild(car);
    }
}